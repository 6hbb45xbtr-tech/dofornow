
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CJ — Add URLs (One or Batch)</title>
  <style>
    body{background:#0b0b0c;color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;padding:24px}
    .card{background:#141416;border:1px solid #2a2a2d;border-radius:12px;padding:16px;max-width:900px;margin:0 auto}
    h1{margin:0 0 10px} .hint{opacity:.7}
    input,textarea,button{font-size:1rem}
    input[type=url],input[type=text]{width:100%;padding:.6rem;border-radius:8px;border:1px solid #333;background:#1b1c1f;color:#eee}
    textarea{width:100%;height:180px;padding:.7rem;border-radius:10px;border:1px solid #333;background:#1b1c1f;color:#eee}
    button{padding:.7rem 1rem;border:1px solid #444;background:#ff6a00;color:#111;border-radius:8px;font-weight:800;cursor:pointer}
    button.secondary{background:#1b1c1f;color:#ddd}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .list{margin-top:14px}
    .ok{color:#93f58d} .bad{color:#ff7777}
    audio{width:100%;margin-top:6px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}
    @media(max-width:860px){.grid{grid-template-columns:1fr}}
    .tag{font-size:.8rem;opacity:.7}
  </style>
</head>
<body>
  <div class="card">
    <h1>CrateJuice — URL Adder</h1>
    <div class="hint">Backend: <span id="api"></span> · Health: <span id="health"></span></div>

    <div class="row">
      <input id="apiInput" type="url" placeholder="Render backend URL (https://...onrender.com)">
      <button id="saveApi" class="secondary">Save API</button>
      <button id="ping" class="secondary">Ping</button>
    </div>

    <div class="grid" style="margin-top:8px">
      <div>
        <h3>Rip ONE</h3>
        <input id="oneUrl" type="url" placeholder="Paste one URL…">
        <div class="row">
          <input id="title" type="text" placeholder="Optional title (will name the MP3)">
          <button id="ripOneBtn">Rip One</button>
        </div>
      </div>

      <div>
        <h3>Rip BATCH</h3>
        <textarea id="batch"></textarea>
        <div class="row">
          <input id="prefix" type="text" placeholder="Optional title prefix (e.g., vol1)">
          <button id="ripBatchBtn">Rip Batch</button>
        </div>
        <div class="tag">One URL per line. Supports YouTube, SoundCloud, direct MP3/OGG links.</div>
      </div>
    </div>

    <div class="row">
      <button id="refresh" class="secondary">Refresh Recent</button>
      <button id="clear" class="secondary">Clear Output</button>
    </div>

    <h3>Result</h3>
    <div id="out" class="list"></div>

    <h3>Recent</h3>
    <div id="recent" class="list"></div>
  </div>

<script>
const apiSpan = document.getElementById('api');
const apiInput = document.getElementById('apiInput');
const saveApiBtn = document.getElementById('saveApi');
const pingBtn = document.getElementById('ping');
const ripOneBtn = document.getElementById('ripOneBtn');
const ripBatchBtn = document.getElementById('ripBatchBtn');
const refreshBtn = document.getElementById('refresh');
const clearBtn = document.getElementById('clear');

let API = localStorage.getItem('cj_api') || '';

function setApi(v){
  API = v.trim();
  localStorage.setItem('cj_api', API);
  apiSpan.textContent = API || '(not set)';
  apiInput.value = API;
}
setApi(API);

saveApiBtn.onclick = ()=> setApi(apiInput.value);

async function ping(){
  try{
    const r = await fetch(API + '/health');
    const j = await r.json();
    document.getElementById('health').textContent = j.ok ? 'OK' + (j.ffmpeg ? ' (ffmpeg)' : '') : 'down';
    document.getElementById('health').className = j.ok ? 'ok' : 'bad';
  }catch(e){
    document.getElementById('health').textContent = 'down';
    document.getElementById('health').className = 'bad';
  }
}
pingBtn.onclick = ping; ping();

function linesToUrls(txt){ return txt.split('\n').map(s=>s.trim()).filter(Boolean).filter(s=>s.startsWith('http')); }

function show(obj){
  document.getElementById('out').innerHTML = '<pre>'+JSON.stringify(obj, null, 2)+'</pre>';
}

async function ripOne(){
  const url = document.getElementById('oneUrl').value.trim();
  const title = document.getElementById('title').value.trim();
  if(!url){ return; }
  const res = await fetch(API + '/rip', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({url, title: title || null})
  });
  const j = await res.json();
  show(j); await refresh();
}
ripOneBtn.onclick = ripOne;

async function ripBatch(){
  const arr = linesToUrls(document.getElementById('batch').value);
  const prefix = document.getElementById('prefix').value.trim() || 'cj';
  if(!arr.length){ return; }
  const res = await fetch(API + '/batch', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({urls: arr, title_prefix: prefix})
  });
  const j = await res.json();
  show(j); await refresh();
}
ripBatchBtn.onclick = ripBatch;

async function refresh(){
  const r = await fetch(API + '/recent');
  const j = await r.json();
  const box = document.getElementById('recent'); box.innerHTML='';
  (j.items||[]).forEach(it=>{
    const div = document.createElement('div');
    div.innerHTML = '<a href="'+API+it.url+'">'+it.file+'</a> · '+Math.round(it.size/1024)+' KB' +
                    '<audio controls src="'+API+it.url+'"></audio>';
    box.appendChild(div);
  });
}
refreshBtn.onclick = refresh;
clearBtn.onclick = ()=> document.getElementById('out').textContent = '';
refresh();
</script>
</body>
</html>
